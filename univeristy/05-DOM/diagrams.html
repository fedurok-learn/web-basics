<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" />

    <!-- jQuery library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.js"></script>
    <!-- Popper JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>

    <!-- Latest compiled JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
</head>

<body>
    <div class="container">
        <div class="row my-4">
            <h3>Середній бал студентів групи КП-72</h3>
        </div>
        <div class="row">
            <table class="table">
                <thead class="thead-dark">
                    <tr>
                        <th scope="col"></th>
                        <th scope="col">Ім'я</th>
                        <th scope="col">Середній бал</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                </tbody>
            </table>
        </div>
        <div class="row my-4">
            <div class="col text-center">
                <button class="btn btn-primary" onclick="addStudent()">Додати студента</button>
            </div>
        </div>
        <div class="row text-center my-4">
            <div class="col">
                <h1>Діаграма</h1>
            </div>
        </div>
        <div class="row text-center align-items-end" style="height: 500px;" id="diagram-container">
        </div>
    </div>

    <script>
        'use strict';

        const tBody = document.getElementById('table-body');
        const diagramContainer = document.getElementById('diagram-container');
        // names to be generated by random
        const stNames = ['Mark', 'Victor', 'Roman', 'Linus', 'Ken', 'Lemmy', 'Korey'];
        // id of a latest student
        var stNum = 0;

        // set actions and validation on change of name and mark fields 
        const setFieldActions = (studentNum) => {
            const isLatin = (val) => /^[a-zA-Z]+$/.test(val);

            // only latin letters allowed at name field
            // trigger enter and update diagram label
            document.getElementById(`student-name-${studentNum}`).onkeypress = (e) => {
                if (e.which == 13) {
                    const newVal = e.target.innerText + String.fromCharCode(e.which);
                    changeDiagramName(studentNum, newVal);
                    e.preventDefault();
                    e.target.blur()
                }

                if (!isLatin(String.fromCharCode(e.which))) e.preventDefault();
            };
            // only numbers allowed at mark field
            // trigger enter and update diagram height
            document.getElementById(`student-mark-${studentNum}`).onkeypress = (e) => {
                if (e.which == 13) {
                    var newVal = e.target.innerText;
                    if(newVal > 100 || (newVal[0] === '0' && newVal.length > 1)) 
                        e.target.innerText = "100";
                    changeDiagramValue(studentNum, e.target.innerText);
                    e.preventDefault()
                    e.target.blur()
                }

                if (isNaN(String.fromCharCode(e.which))) e.preventDefault();
            };

            // trigger when field looses focus
            // (similar to enter key action, just change name or value of diagram) 
            document.getElementById(`student-name-${studentNum}`).onblur = 
                (e) => changeDiagramName(studentNum, e.target.innerText);

            document.getElementById(`student-mark-${studentNum}`).onblur = 
                (e) => changeDiagramValue(studentNum, e.target.innerText);
        }

        const addStudent = (name = "", mark = -1) => {
            // gen random name and mark when not supplied
            if (!name) name = stNames[Math.floor(Math.random() * stNames.length)];
            if (mark === -1) mark = Math.floor(Math.random() * 80 + 20);

            stNum++;
            // append new student to the list
            const tr = document.createElement('tr');
            tr.id = `student${stNum}`;
            tr.innerHTML = `
                <td><button type="button" class="btn btn-link" onclick="removeStudentnDiagram(${stNum})">Видалити</button></td>
                <td><p contenteditable="true" id="student-name-${stNum}">${name}</p></td>
                <td><p contenteditable="true" id="student-mark-${stNum}">${mark}</p></td>
            `;
            tBody.appendChild(tr);

            // disable false characters from typing
            setFieldActions(stNum);

            addDiagram(name, mark);
        }

        const removeStudentnDiagram = (num) => {
            const student = document.getElementById(`student${num}`);
            student.parentNode.removeChild(student);
            const diagram = document.getElementById(`diagram${num}`);
            diagram.parentNode.removeChild(diagram);
        }

        const addDiagram = (name, mark) => {
            const diagram = document.createElement('div');
            diagram.id = `diagram${stNum}`;
            diagram.className = "col";
            diagram.style.cssText = `height: ${mark}%; background-color: ${genBgColor()};`
            diagram.innerHTML = `<h3 class="mt-3" id="diagram-name-${stNum}">${name}</h3>`;
            diagramContainer.appendChild(diagram);

            // and add tooltip on mouse over
            // that will show student mark
            var tooltip = document.createElement('p');
            tooltip = tooltip.appendChild(document.createElement('h2'))
            var curNum = stNum;
            diagram.onmouseover = () => {
                tooltip.innerText = document.getElementById(`student-mark-${curNum}`).innerText;
                diagram.appendChild(tooltip);
            }
            diagram.onmouseleave = () => {
                diagram.removeChild(tooltip);
            }
        }

        const genBgColor = () => {
            var letters = '0123456789ABCDEF';
            var color = '#';
            for (var i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        const changeDiagramName = (num, val) => {
            console.log(val);
            document.getElementById(`diagram-name-${num}`).innerText = val;
        }

        const changeDiagramValue = (num, val) => {
            console.log(val);
            console.log(num);
            document.getElementById(`diagram${num}`).style.height = `${val}%`;
        }

        for (let i = 0; i < Math.floor(Math.random() * 3 + 2); ++i) 
            addStudent();
    </script>
</body>


</html>